{% extends 'base.html' %}
{% load static %}

{% block title %}
Manga Reader - Read Manga
{% endblock %}

{% block content %}
<div class="flex h-full">
    <!-- Thumbnails of uploaded images -->
    <div class="w-fit bg-gray-800 border-r border-gray-700 h-full flex flex-col">
        <div class="flex-grow overflow-y-auto p-4">
            {% for thumbnail in thumbnails %}
            <div class="w-full h-24 md:h-64 overflow-hidden rounded-lg shadow mb-2">
                <img src="/media/uploaded_images/{{ thumbnail }}" alt="{{ thumbnail }}"
                     class="w-full h-full object-cover hover:opacity-75 transition">
            </div>
            {% endfor %}
        </div>
        <div class="">
            <a href="/" class="bg-gray-700 text-white py-2 px-4 rounded hover:bg-blue-700 transition shadow-lg w-full block text-center">
                New Import
            </a>
        </div>
    </div>
    
    <!-- Previewer -->
    <div class="flex-grow flex flex-col items-center px-6 min-h-0 overflow-hidden">
        {% if panels %}
        <div class="flex-grow flex px-6 space-x-4 w-full min-h-0">
            <div id="previewer" class="flex-grow w-full h-full bg-white flex items-center justify-center overflow-hidden rounded-lg relative">
                <img id="preview-image" src="" alt="Panel Preview" class="w-full h-full object-contain">
                <!-- Play Overlay Icon -->
                <div id="play-overlay" class="absolute top-2 left-2 bg-opacity-50 text-red-600 rounded-full p-3 hidden blink">
                    <i class="fas fa-play text-xl"></i>
                </div>
            </div>

            <div id="text-content" class="w-[30vh] flex-grow h-full bg-gray-100 rounded-lg p-4 overflow-y-auto">
                <h3 class="text-lg font-bold mb-2">Textes détectés :</h3>
                <ul id="text-list"></ul>
            </div>
        </div>

        <div class="w-full flex justify-center mt-4 px-6">
            <input id="slider" type="range" min="0" max="{{ panels|length }}" value="0" 
                   class="w-full appearance-none h-2 bg-gray-400 rounded-lg slider-thumb focus:outline-none focus:ring-2 focus:ring-gray-800 transition">
        </div>

        <div class="flex justify-center mt-4 space-x-4">
            <button id="first-button" class="bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-500 transition shadow">
                <i class="fas fa-angle-double-left"></i>
            </button>
            <button id="prev-button" class="bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-500 transition shadow">
                <i class="fas fa-angle-left"></i>
            </button>
            <button id="play-button" class="bg-gray-600 text-white py-2 px-4 rounded hover:bg-green-600 transition shadow">
                <i class="fas fa-play"></i>
            </button>
            <button id="next-button" class="bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-500 transition shadow">
                <i class="fas fa-angle-right"></i>
            </button>
            <button id="last-button" class="bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-500 transition shadow">
                <i class="fas fa-angle-double-right"></i>
            </button>
        </div>
        {% else %}
        <p class="text-gray-500 text-center">No panels to display.</p>
        {% endif %}
    </div>
</div>

<script id="panels-data" type="application/json">{{ panels|safe }}</script>
<script id="texts-data" type="application/json">{{ texts|safe }}</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Retrieve the panels and texts data from the script tags
        const panelsDataElement = document.getElementById("panels-data");
        const textsDataElement = document.getElementById("texts-data");
      
        let panels = [];
        let texts = [];
        let currentIndex = 0;
        let playInterval = null;
      
        if (panelsDataElement) {
          try {
            panels = JSON.parse(panelsDataElement.textContent);
            console.log("Panels data loaded:", panels);
          } catch (error) {
            console.error("Error parsing panels data:", error);
          }
        } else {
          console.error("Panels data element not found.");
        }
      
        if (textsDataElement) {
          try {
            texts = JSON.parse(textsDataElement.textContent);
            console.log("Texts data loaded:", texts);
          } catch (error) {
            console.error("Error parsing texts data:", error);
          }
        } else {
          console.error("Texts data element not found.");
        }
      
        // Get references to the DOM elements
        const previewImage = document.getElementById("preview-image");
        const textList = document.getElementById("text-list");
        const prevButton = document.getElementById("prev-button");
        const nextButton = document.getElementById("next-button");
        const firstButton = document.getElementById("first-button");
        const lastButton = document.getElementById("last-button");
        const playButton = document.getElementById("play-button");
        const slider = document.getElementById("slider");
        const playOverlay = document.getElementById("play-overlay");
      
        // Update slider range and value
        slider.max = panels.length - 1;
      
        // Function to update the preview image and associated text
        function updateContent(index) {
          if (panels.length > 0 && previewImage) {
            const panelBase64 = panels[index];
            previewImage.src = `data:image/jpeg;base64,${panelBase64}`;
            slider.value = index;
      
            // Update the text list
            if (texts[index]) {
              textList.innerHTML = texts[index]
                .map(
                  (text) =>
                    `<li class="font-serif italic text-gray-800 text-lg">${text}</li></br>`
                )
                .join("");
            } else {
              textList.innerHTML = `<li class="text-gray-500 italic"></li>`;
            }
          } else {
            console.warn("No panels to display or preview image element not found.");
          }
        }
      
        // Function to toggle play/pause
        function togglePlayPause() {
          if (playInterval) {
            clearInterval(playInterval);
            playInterval = null;
            playButton.innerHTML = '<i class="fas fa-play"></i>'; // Change icon to play
            playButton.classList.replace("bg-green-600", "bg-gray-600");
            playOverlay.classList.add("hidden"); // Hide play overlay
          } else {
            playInterval = setInterval(() => {
              if (currentIndex < panels.length - 1) {
                currentIndex++;
                updateContent(currentIndex);
              } else {
                togglePlayPause(); // Automatically pause at the last panel
              }
            }, 3000); // Change every 3 seconds
            playButton.innerHTML = '<i class="fas fa-pause"></i>'; // Change icon to pause
            playButton.classList.replace("bg-gray-600", "bg-green-600");
            playOverlay.classList.remove("hidden"); // Show play overlay
          }
        }
      
        // Event listeners for navigation buttons
        if (firstButton) {
          firstButton.addEventListener("click", () => {
            currentIndex = 0;
            updateContent(currentIndex);
          });
        }
      
        if (prevButton) {
          prevButton.addEventListener("click", () => {
            if (currentIndex > 0) {
              currentIndex--;
              updateContent(currentIndex);
            }
          });
        }
      
        if (nextButton) {
          nextButton.addEventListener("click", () => {
            if (currentIndex < panels.length - 1) {
              currentIndex++;
              updateContent(currentIndex);
            }
          });
        }
      
        if (lastButton) {
          lastButton.addEventListener("click", () => {
            currentIndex = panels.length - 1;
            updateContent(currentIndex);
          });
        }
      
        if (playButton) {
          playButton.addEventListener("click", togglePlayPause);
        }
      
        // Event listener for the slider
        slider.addEventListener("input", (e) => {
          currentIndex = parseInt(e.target.value, 10);
          updateContent(currentIndex);
        });
      
        // Initial call to display the first panel
        updateContent(currentIndex);
      });
      
</script>
<style>
    /* Add blinking animation */
    @keyframes blink {
        0% {
            opacity: 0.5;
        }
        50% {
            opacity: 1;
        }
        100% {
            opacity: 0.5;
        }
    }

    .blink {
        animation: blink 1.5s infinite;
    }

    /* Styling for slider thumb */
    input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        background: #3294f0; /* Blue color */
        border-radius: 50%;
        cursor: pointer;
    }

    input[type="range"]:focus::-webkit-slider-thumb {
        box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.3);
    }

    input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        background: #3294f0;
        border: none;
        border-radius: 50%;
        cursor: pointer;
    }

    input[type="range"]:focus::-moz-range-thumb {
        box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.3);
    }

</style>   

{% endblock %}
